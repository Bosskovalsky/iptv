name: "Update"

on:
  workflow_dispatch:
  schedule:
    - cron: '40 19 * * *'

jobs:
  updater:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Install
      run:  curl -s https://raw.githubusercontent.com/blackbirdstudiorus/LoganetXIPTV/main/LoganetXAll.m3u > playlist.m3u
    - name: Install 2
      run: curl -s https://raw.githubusercontent.com/iptv-org/iptv/master/streams/ru.m3u | grep -A 1 'PervyyTulskiy' | sed 's/tvg-id="PervyyTulskiy.ru"/group-title="Спорт"/' >> playlist.m3u
    - name: Commit files
      env:
        GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
      run: |
        set -euo pipefail

        git remote add github "https://${GITHUB_ACTOR}:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
        git pull github ${GITHUB_REF} --ff-only

        # Get name & email from 1st commit (needs `fetch-depth: 0` in step `actions/checkout@v3`)
        git config --local user.email "$(git log --format='%ae' --reverse | head -1)"
        git config --local user.name "$(git log --format='%an' --reverse | head -1)"

        # try commit
        git add .
        if [ -z "$(git status --porcelain)" ]; then
          echo 'No changes'
          exit 0
        fi
        git commit -m "Auto-update"

        # push changes
        git push github HEAD:${GITHUB_REF}
